<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script src="../three.js/build/three.min.js"></script>
	<script src="../three.js/examples/js/Detector.js"></script>
	<script src="../three.js/examples/js/libs/stats.min.js"></script>
	<script src="../three.js/examples/js/controls/OrbitControls.js"></script>
	<script src="js/Util.js"></script>
	<script src="js/Atlas.js"></script>
	<script src="js/ParticleSystem.js"></script>
	<script src="js/ParticleSystemFrameset.js"></script>
	<script src="../three.js/examples/js/loaders/OBJLoader.js"></script>
	<script type='text/javascript' src='../three.js/examples/js/libs/dat.gui.min.js'></script>

    <link rel="stylesheet" href="css/main.css" type="text/css" media="screen" />
    <title>Three.js Particle System</title>
</head>
<body>

<div id="renderingContainer" style="position: absolute; left:0px; top:0px"></div>

<script>

	var ParticleSystemIDs = Object.freeze(
	{
		Sparks: 1,
		Smoke: 2,
		Flame: 3
	});

	var rendererContainer;
	var screenWidth, screenHeight;
	var particleSystem, particleSystems, pointLight, loadingManager;
	var scene, camera, renderer, controls, stats, clock;
	var currentSystemID;

	$( document ).ready( function() {

		init();
		animate();

	});

	function init() 
	{
		clock = new THREE.Clock();		

		getScreenDimensions();

		Util.initializeLoadingManager();
		initRenderer();
		initScene();
		initControls();
		initStats();		
		initGUI();
		initListeners();

		initParticleSystems();
		startParticleSystem ( ParticleSystemIDs.Flame );

	}

	function initParticleSystems() {

		particleSystems = {};

		particleSystemPresetsSparks = {

			zSort: true,

			initialPositionRangeType : ParticleSystem.RangeType.Cube,
			initialPositionOffset : new THREE.Vector3( 0,  5, 0 ),
			initialPositionRange : new THREE.Vector3( 10, 0, 10 ),
			
			initialVelocityRangeType : ParticleSystem.RangeType.Cube,
			initialVelocityOffset : new THREE.Vector3( 0,  160, 0 ),
			initialVelocityRange : new THREE.Vector3( 100, 20, 100 ), 

			initialAccelerationOffset : new THREE.Vector3( 0, -100, 0 ),
			
			particleAtlas : new Atlas( THREE.ImageUtils.loadTexture( 'images/star.png' ), true ),

			initialRotationOffset : 0,
			initialRotationRange  : 180,
			initialAngularVelocityOffset : 100,
			initialAngularVelocityRange : 360 * 4,
			
			atlasFrameSet: new ParticleSystem.FrameSet( [0, 3], [0, 0] ),
			sizeFrameSet : new ParticleSystem.FrameSet( [ 0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0 ], 
				                                           [ new THREE.Vector3( 1, 1 ), new THREE.Vector3( 3, 1.5 ),  new THREE.Vector3( 2, 4 ),  new THREE.Vector3( 5, 2.5 ), new THREE.Vector3( 3, 6 ), new THREE.Vector3( 7, 3.5 ), new THREE.Vector3( 4, 8 ) ] ),
			alphaFrameSet : new ParticleSystem.FrameSet( [2, 3], [1, 0] ),
			colorFrameSet : new ParticleSystem.FrameSet( [0.0, 1.0, 2], [ new THREE.Vector3(1.0,1.0,0.0), new THREE.Vector3(1.0, 0.0, 0.0), new THREE.Vector3(0.6, 0.0, 0.0) ] ),

			particleReleaseRate : 200,
			particleLifeSpan : 3.0,		
			emitterDeathAge : 60

		};
		particleSystems[ ParticleSystemIDs.Sparks ] = new ParticleSystem();
		particleSystems[ ParticleSystemIDs.Sparks ].initialize( camera, particleSystemPresetsSparks );

		particleSystemPresetsSmoke = {

			zSort: true,

			initialPositionRangeType : ParticleSystem.RangeType.Sphere,
			initialPositionOffset : new THREE.Vector3( 0, 0, 0 ),
			initialPositionRange : new THREE.Vector3( 10, 0, 10 ),

			initialVelocityRangeType : ParticleSystem.RangeType.Sphere,
			initialVelocityOffset : new THREE.Vector3( 0, 75, 0 ),
			initialVelocityRange : new THREE.Vector3( 30, 25, 30 ), 
			initialAccelerationOffset : new THREE.Vector3( 0,-10,0 ),
			
			particleAtlas : new Atlas( THREE.ImageUtils.loadTexture( 'images/smokeparticle.png' ), true ),

			initialRotationOffset : 0,
			initialRotationRange : 360,
			initialAngularVelocityOffset : 50,
			initialAngularVelocityRange : 400,

			atlasFrameSet: new ParticleSystem.FrameSet( [0, 4], [0, 0] ),		
			sizeFrameSet : new ParticleSystem.FrameSet( [0, 4], [ new THREE.Vector2( 10, 10 ), new THREE.Vector2( 50, 50 ) ] ),
			alphaFrameSet : new ParticleSystem.FrameSet( [0, 0.6, 4], [0.0, 0.5, 0.0] ),
			colorFrameSet : new ParticleSystem.FrameSet( [0.0, 1.5, 4], [ new THREE.Vector3( 0.1, 0.1, 0.1 ), new THREE.Vector3( 0.35, 0.35, 0.35 ), new THREE.Vector3( 0.7, 0.7, 0.7 ) ] ),

			particleReleaseRate : 200,
			particleLifeSpan : 4.0,		
			emitterDeathAge : 60

		};
		particleSystems[ ParticleSystemIDs.Smoke ] = new ParticleSystem();
		particleSystems[ ParticleSystemIDs.Smoke ].initialize( camera, particleSystemPresetsSmoke );

		particleSystemPresetsFlame = {

			initialPositionRangeType : ParticleSystem.RangeType.Cube,
			initialPositionOffset : new THREE.Vector3( 0, 7 , 0 ),
			initialPositionRange : new THREE.Vector3( 3, 0, 3 ),
			
			initialVelocityRangeType : ParticleSystem.RangeType.Cube,
			initialVelocityOffset : new THREE.Vector3(0,25,0),
			initialVelocityRange : new THREE.Vector3(10,5,10),

			initialRotationOffset : 0,
			initialRotationRange : 0,

			particleAtlas : Atlas.createGridAtlas( THREE.ImageUtils.loadTexture( 'images/fireloop3.jpg' ), 0.0, 1.0, 1.0, 0.0, 8.0, 8.0, false, true ),
			
			atlasFrameSet: new ParticleSystem.FrameSet( [0, 3], [0, 63] ),
			sizeFrameSet : new ParticleSystem.FrameSet( [ 0, 3], [ new THREE.Vector3( 20, 25 ), new THREE.Vector3( 20, 25 ) ] ),
			
			alphaFrameSet : new ParticleSystem.FrameSet( [0, 0.2, 1.2, 2.0, 3], [ 0, .3, 1, 1, 0] ),
			colorFrameSet : new ParticleSystem.FrameSet( [0, 3], [ new THREE.Vector3(1.4, 1.4, 1.4), new THREE.Vector3(1.4, 1.4, 1.4) ] ),
			blendStyle : THREE.AdditiveBlending,  
			
			particleReleaseRate : 3,
			particleLifeSpan : 3,		
			emitterDeathAge : 60

		};
		particleSystems[ ParticleSystemIDs.Flame ] = new ParticleSystem();
		particleSystems[ ParticleSystemIDs.Flame ].initialize( camera, particleSystemPresetsFlame );

	}

	function initGUI() {

		gui = new dat.GUI();	
		parameters = 
		{
			sparks:  function() { startParticleSystem( ParticleSystemIDs.Sparks ); },	
			smoke:  function() { startParticleSystem( ParticleSystemIDs.Smoke ); },				
			flame:  function() { startParticleSystem( ParticleSystemIDs.Flame ); }		
		};

		gui.add( parameters, 'sparks').name( "Sparks" );	
		gui.add( parameters, 'smoke' ).name( "Smoke" );
		gui.add( parameters, 'flame' ).name( "Flame" );
		
		gui.open();

	}

	function initListeners() {

        window.addEventListener( 'resize', onWindowResize, false );
        
    }

	function initRenderer() {

		renderer = new THREE.WebGLRenderer();
        renderer.setSize( screenWidth, screenHeight );
        renderer.setClearColor( 0x000000 );
        renderer.shadowMap.enabled = true;
		renderer.shadowMap.type = THREE.PCFSoftShadowMap;
		rendererContainer = document.getElementById( 'renderingContainer' );
		rendererContainer.appendChild( renderer.domElement );

	}

	function initLights() {

		pointLight = new THREE.PointLight( 0xffffff, 2, 1000, 1);
		pointLight.position.set(0,40,0);
		pointLight.castShadow = true;
		pointLight.shadowCameraNear = 1;
		pointLight.shadowCameraFar = 1000;
		pointLight.shadowDarkness = .8;
		// pointLight.shadowCameraVisible = true;
		pointLight.shadowMapWidth = 2048;
		pointLight.shadowMapHeight = 1024;
		pointLight.shadowBias = 0.0;
		scene.add(pointLight);

	}

	function initSceneGeometry() {

		Util.loadObj( 'models/CamFire01.obj', 'models/Stuff01.png', true, true, function( object ) {

			object.position.set( 0, 0, 0 );
			object.scale.set( 7, 7, 7 );
			object.castShadow = true;
			object.receiveShadow = true;
			scene.add( object );

		} );		

		var sphereGeometry = new THREE.SphereGeometry( 10, 32, 32 );
		var sphereMaterial = new THREE.MeshLambertMaterial( { color: 0xffffff } );
		var sphere = new THREE.Mesh( sphereGeometry, sphereMaterial );
		sphere.castShadow = true;
		sphere.receiveShadow = true;
		sphere.position.set(-40, 10, 40);
		scene.add( sphere );

		var boxGeometry = new THREE.BoxGeometry( 20, 20, 20 );
		var boxMaterial = new THREE.MeshLambertMaterial( { color: 0xffffff } );
		var box = new THREE.Mesh( boxGeometry, boxMaterial );
		box.castShadow = true;
		box.receiveShadow = true;
		box.position.set(-40, 10, -40);
		scene.add( box );

		var groundTexture = new THREE.ImageUtils.loadTexture( 'images/stoneground.png' );
		groundTexture.wrapS = THREE.RepeatWrapping; 
		groundTexture.wrapT = THREE.RepeatWrapping; 
		groundTexture.repeat.set( 10, 10 );

		var groundMaterial = new THREE.MeshLambertMaterial( {

                color: 0xffffff,
                shading: THREE.SmoothShading,
                map: groundTexture,
                vertexColors: THREE.NoColors,
                side: THREE.DoubleSide

        } );

		var groundGeometry = new THREE.PlaneGeometry( 1000, 1000, 30, 30 );
		var groundMesh = new THREE.Mesh( groundGeometry, groundMaterial );
		groundMesh.position.y = 0;
		groundMesh.rotation.x = Math.PI / 2.0;
		groundMesh.receiveShadow = true;
		scene.add(groundMesh);

	}

	function initScene() {

		scene = new THREE.Scene();

		camera = new THREE.PerspectiveCamera( 45, 1.0, 2, 2000 );
		scene.add(camera);
		resetCamera();

		initLights();
		initSceneGeometry();
		
	}

	function initStats() {

		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.bottom = '0px';
		stats.domElement.style.zIndex = 100;
		rendererContainer.appendChild( stats.domElement );

	}

	function initControls() {

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        controls.target.set( 0, 0, 0 );
        controls.update();

    }

	function onWindowResize() { 

		renderer.setSize( screenWidth, screenHeight );
		resetCamera();		

	}

	function animate() {

	    requestAnimationFrame( animate );
	    update();
		render();	

	}

	var flickerPointLight = ( function() {

		var lastAdjuster;

		return function flickerPointLight() {

			var adjuster = (Math.random() - 0.5);

			if( lastAdjuster ) {

				diff = (adjuster - lastAdjuster) *.2;
				adjuster = lastAdjuster + diff;

			}

			var intensity = 6;
			intensity += adjuster * 4;
			pointLight.intensity = intensity;

			pointLight.distance = adjuster * 50 + 200;
			pointLight.color.setRGB(1,.8,.2);
			pointLight.decay = adjuster * 5 + 3;

			lastAdjuster = adjuster;
		}

	})();


	function startParticleSystem( id ) {

		resetCamera();
		
		if( particleSystem ){

			particleSystem.deactivate();

		}

		currentSystemID = id;
		if( id == ParticleSystemIDs.Sparks ) {

			particleSystem = particleSystems[ ParticleSystemIDs.Sparks ]; 
			pointLight.distance = 1000;
			pointLight.intensity = 1;
			pointLight.color.setRGB( 1,1,1);
			pointLight.decay = 2;

		} else if( id == ParticleSystemIDs.Smoke ) {
			
			particleSystem = particleSystems[ ParticleSystemIDs.Smoke ]; 
			pointLight.distance = 50000;
			pointLight.intensity = 1;
			pointLight.color.setRGB( 1,1,1);
			pointLight.decay = 0;

		} else if( id == ParticleSystemIDs.Flame ) {
			
			particleSystem = particleSystems[ ParticleSystemIDs.Flame ];  
			pointLight.distance = 300;
			pointLight.intensity = 6;
			pointLight.color.setRGB( 1, .7, 0);
			pointLight.decay = 2;

		} else {

			return;
		}

		particleSystem.activate();

	}

	function getScreenDimensions() {

		screenWidth = window.innerWidth;
		screenHeight = window.innerHeight;

	}

	function resetCamera() {

		getScreenDimensions();
		camera.aspect = screenWidth / screenHeight;
		camera.updateProjectionMatrix();
		camera.position.set(0,200,400);
		camera.lookAt(scene.position);	

	}

	function update() {

		controls.update();
		stats.update();
		
		var deltaTime = clock.getDelta();
		particleSystem.update( deltaTime );	

		if ( currentSystemID == ParticleSystemIDs.Flame ) {

			flickerPointLight();

		}

	}

	function render() {

		renderer.render( scene, camera );

	}

</script>
</body>
</html>
